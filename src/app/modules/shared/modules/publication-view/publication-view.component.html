<div class="content-publication-view" *ngIf="publication">
  <div class="publication-header-actions"
    (mouseenter)="checkDataLink(publication.author._id)">
    <div *ngIf="publication.fixed" class="material-icons fixed">push_pin</div>
    <worky-dropdown
      icon="more_horiz"
      [badge]=false
      (click)="checkDataLink(publication.author._id)"
      [dataLink]="dataLinkActions"
      (linkClicked)="handleActionsClicked($event, publication)">
    </worky-dropdown>
  </div>

  <div class="publication-header">
    <!-- Avatar con skeleton individual -->
    <div *ngIf="avatarLoading" class="avatar-container">
      <worky-avatar-skeleton size="40px"></worky-avatar-skeleton>
    </div>
    <worky-avatar *ngIf="!avatarLoading"
      [size]="40"
      [img]="publication.author.avatar"
      [name]="publication.author.name + ' ' + publication.author.lastName"
      (load)="onAvatarLoad()"
      (error)="onAvatarError()">
    </worky-avatar>

    <div class="publication-header-content">
      <div class="user-name-content">
        <!-- Nombre con skeleton individual -->
        <div *ngIf="nameLoading" class="name-skeleton">
          <worky-text-skeleton width="120px"></worky-text-skeleton>
        </div>
        <div class="user-name" *ngIf="!nameLoading && (publication.isMyFriend || (dataUser?.id === publication.userReceiving?._id && !publication.isMyFriend) || (dataUser?.id === publication.author._id && !publication.isMyFriend)); else notFriend">
          <span (click)="viewProfile(publication.author._id)" class="name link-name">
            {{ publication.author.name }} {{ publication.author.lastName }}
          </span>
          <i *ngIf="publication.userReceiving" class="material-icons">keyboard_arrow_right</i>
          <ng-container *ngIf="publication.userReceiving">
              <span (click)="viewProfile(publication.userReceiving._id)" class="name link-name">
                {{ publication.userReceiving.name }} {{ publication.userReceiving.lastName }}
              </span>
          </ng-container>
        </div>

        <ng-template #notFriend>
          <div class="content-actions-follow">
            <span (click)="viewProfile(publication.author._id)" class="name link-name">
              {{ publication.author.name }} {{ publication.author.lastName }}
            </span>

            <span class="name">
              <ng-container *ngIf="!isProfile">
                <i *ngIf="!publication.isMyFriend || publication.isFriendshipPending" class="material-icons">fiber_manual_record</i>

                <a *ngIf="!publication.isMyFriend && (!userRequest?._id || !userReceive?._id)" class="follow-my-friend"
                  (click)="followMyFriend(publication.author._id)">
                  {{ 'publicationsView.follow' | workyTranslations }}
                </a>

                <a *ngIf="!publication.isMyFriend && publication.isFriendshipPending && userRequest?._id === dataUser?.id" class="follow-my-friend"
                  (click)="cancelFriendship(publication.isFriendshipPending!, publication.author._id)">
                  {{ 'publicationsView.cancelRequest' | workyTranslations }}
                </a>

                <a *ngIf="userReceive?._id === dataUser?.id" class="follow-my-friend"
                  (click)="acceptFriendship(publication.isFriendshipPending!, publication.author._id)">
                  Aceptar Amistad
                </a>

              </ng-container>
            </span>

          </div>
        </ng-template>

      </div>
      <!-- Ubicación con skeleton individual -->
      <div *ngIf="locationLoading" class="location-skeleton">
        <worky-text-skeleton width="150px"></worky-text-skeleton>
      </div>
      <span class="geoLocationName" *ngIf="nameGeoLocation !== '' && !locationLoading"> <p class="is-in">{{ 'shared.publicationView.location.isIn' | workyTranslations }} </p><a class="urlLink" [href]="urrMap" target="_blank">{{ nameGeoLocation }}</a></span>
      <div class="publication-date">
        <!-- Fecha con skeleton individual -->
        <div *ngIf="dateLoading" class="date-skeleton">
          <worky-text-skeleton width="80px"></worky-text-skeleton>
        </div>
        <span *ngIf="!dateLoading">{{ publication.createdAt! | workyDate:'relative' }}</span>
        <ng-container *ngIf="publication.privacy === typePrivacy.PUBLIC">
          <i class="material-icons">public</i>
        </ng-container>
        <ng-container *ngIf="publication.privacy === typePrivacy.FRIENDS">
          <i class="material-icons">people</i>
        </ng-container>
        <ng-container *ngIf="publication.privacy === typePrivacy.PRIVATE">
          <i class="material-icons">lock</i>
        </ng-container>
      </div>
    </div>
  </div>

  <div class="publication-body">
    <div class="publication-content" *ngIf="publication.content">
      <!-- Contenido con skeleton individual -->
      <div *ngIf="contentLoading" class="content-skeleton">
        <worky-text-skeleton width="100%"></worky-text-skeleton>
        <worky-text-skeleton width="80%"></worky-text-skeleton>
        <worky-text-skeleton width="60%"></worky-text-skeleton>
      </div>
      <div class="content markdown" *ngIf="!contentLoading && (publication.content | workyPreviewHtml | async) as result">
        <div class="publication-markdown-view" [innerHTML]="result.markdownHtml"></div>
        <div class="publication-youtube-preview" [innerHTML]="result.youTubeHtml"></div>
        <div class="publication-url-preview" [innerHTML]="result.previewsHtml"></div>
      </div>
    </div>

    <worky-processing-media *ngIf="!publication.media.length && publication.containsMedia"></worky-processing-media>

    <!-- Media con skeleton individual -->
    <div *ngIf="publication.media.length && mediaLoading" class="media-skeleton">
      <worky-image-skeleton width="100%" height="300px"></worky-image-skeleton>
    </div>
    <worky-image-organizer *ngIf="publication.media.length && !mediaLoading"
      [publication]="publication"
      type="publication">
    </worky-image-organizer>
  </div>

  <div class="publication-footer">
    <div class="publication-footer-content">
      <div class="publication-footer-content-item" *ngIf="publication.reaction.length">
        <div class="reactions-img-container" *ngFor="let emoji of listReaction; let i = index;">
          <img
            class="reactions-img"
            [src]="emoji"
            [alt]="'Reacción ' + (i + 1)"
            [style.--i]="i"
            (error)="onEmojiError($event)">
        </div>
        <span>{{ publication.reaction.length }}</span>

      </div>
      <div class="publication-footer-content-item" *ngIf="publication.comment.length" (click)="viewCommentsOn(indexPublication!)">
        <span> {{ publication.comment.length }} </span>
        <span> {{ 'publicationsView.spanComments' | workyTranslations }} </span>
      </div>
    </div>

    <div class="publication-footer-actions">
      <!-- Botones de acción con skeleton individual -->
      <div class="publication-footer-actions-item" *ngIf="actionsLoading">
        <worky-button-skeleton width="60px" height="30px"></worky-button-skeleton>
      </div>
      <div class="publication-footer-actions-item" *ngIf="!actionsLoading">
        <worky-reactions
          [type]="type"
          [userProfile]="userProfile"
          [publication]="publication"
          [reactionsToPublication]="publication.reaction">
        </worky-reactions>
      </div>
      
      <div class="publication-footer-actions-item" *ngIf="actionsLoading">
        <worky-button-skeleton width="80px" height="30px"></worky-button-skeleton>
      </div>
      <div class="publication-footer-actions-item no-select-text" *ngIf="!actionsLoading" (click)="commentOn(indexPublication!)">
        <i class="material-icons">comment</i>
        <span>{{ 'publicationsView.spanComment' | workyTranslations }}</span>
      </div>
      
      <div class="publication-footer-actions-item" *ngIf="actionsLoading">
        <worky-button-skeleton width="60px" height="30px"></worky-button-skeleton>
      </div>
            <div class="publication-footer-actions-item no-select-text" *ngIf="!actionsLoading">
        <worky-dropdown
          icon="share"
          [title]="'publicationsView.spanShare' | workyTranslations"
          [badge]=false
          (click)="checkDataLink(publication.author._id)"
          [dataLink]="dataShareActions"
          (linkClicked)="handleActionsClicked($event, publication)">
        </worky-dropdown>
      </div>
    </div>
  </div>

  <div class="publication-comment-on" *ngIf="viewCommentSection === indexPublication">
    <worky-add-publication
      [type]="typePublishing.COMMENT"
      [idPublication]="publication._id"
      [indexPublication]="indexPublication">
    </worky-add-publication>
  </div>

  <div class="publication-comment" *ngIf="viewComments === indexPublication">
    <div class="publication-comment-item" *ngFor="let comment of publication.comment">
      <worky-avatar
        [size]="30"
        [img]="comment.author.avatar"
        [name]="comment.author.name + ' ' + comment.author.lastName">
      </worky-avatar>
      <div class="publication-comment-content">
        <div class="publication-comment-data">
          <div class="content-name-header">
            <span class="comment-author"
              [class.link-profile]="comment.author._id !== dataUser?.id"
              [routerLink]="comment.author._id !== dataUser?.id ? ['/profile/'+ comment.author._id] : null">
              {{ comment.author.name }} {{ comment.author.lastName }}
            </span>
            <div *ngIf="comment.author._id === dataUser?.id"
              class="material-icons delete-comment"
              (click)="deleteComment(comment._id, publication._id)">delete</div>
          </div>
          <div class="comment-content markdown" *ngIf="(comment.content | workyPreviewHtml | async) as result">
            <div [innerHTML]="result.markdownHtml"></div>
            <div class="publication-youtube-preview" [innerHTML]="result.youTubeHtml"></div>
            <div class="publication-url-preview" [innerHTML]="result.previewsHtml"></div>
          </div>

          <worky-processing-media *ngIf="!comment.media.length && comment.containsMedia"></worky-processing-media>

          <worky-image-organizer *ngIf="comment.media.length"
            [comment]="comment"
            [publication]="publication"
            type="comment">
          </worky-image-organizer>
        </div>
        <span class="comment-date">{{ comment.createdAt | workyDate:'relative' }}</span>
      </div>
    </div>
  </div>
</div>
